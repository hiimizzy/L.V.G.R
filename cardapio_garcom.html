<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card√°pio - L.V.G.R</title>
  <link rel="shortcut icon" href="lua.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome para o √≠cone da lixeira -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-[var(--cor-preto)] text-[#ffffff]">

<header class="bg-[var(--cor-marrom)] text-center py-6">
  <img src="img/hamb-1.png" alt="foto" class="w-32 h-32 mx-auto rounded-full shadow-lg border-4 border-white" />
  <h1 class="text-4xl font-semibold">L.V.G.R</h1>
  <p class="text-sm mt-4">Fa√ßa seu pedido com carinho üíö</p>
</header>

<!-- Se√ß√£o do Card√°pio -->
<section class="max-w-4xl mx-auto py-10 px-4">
  <h2 class="text-2xl text-center mb-6">Nosso Card√°pio</h2>
  <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
  </div>
</section>
<!-- Fim da Se√ß√£o do Car√°pio -->

<!-- Se√ß√£o do Carrinho -->
<section class="max-w-4xl mx-auto px-4 pb-10">
  <h2 class="text-2xl font-semibold text-center mb-4">Carrinho</h2>
  <table class="w-full bg-white rounded shadow text-center text-[#ff5400]">
    <thead class="bg-[var(--cor-laranja)] text-white">
      <tr>
        <th class="py-2">Item</th>
        <th>Quantidade</th>
        <th>Pre√ßo</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="carrinho-corpo">
      <!-- Itens do carrinho ser√£o inseridos aqui -->
    </tbody>
  </table>
  <p id="total-carrinho" class="text-right mt-2 font-bold">Total: R$ 0,00</p>
  <div class="text-center mt-4">
    <div class="mb-4">
      <label for="mesa-select" class="block text-white mb-2">Selecione a Mesa:</label>
      <select id="mesa-select" class="w-full p-2 rounded bg-white text-[#ff5400]">
      </select>
    </div>
    <button id="confirmar-pedido" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
      Confirmar Pedido
    </button>
  </div>
</section>

<script src="api.js"></script>
<script>
  // ----- Carrinho (armazenado em mem√≥ria e sincronizado com localStorage) -----
  let carrinho = {};
  let allProducts = [];

  // Carregar carrinho do localStorage, se existir
  if (localStorage.getItem('catcafe-carrinho')) {
    carrinho = JSON.parse(localStorage.getItem('catcafe-carrinho'));
  }

  // ----- Fun√ß√µes auxiliares -----
  function salvarCarrinho() {
    localStorage.setItem('catcafe-carrinho', JSON.stringify(carrinho));
  }

  function formatarPreco(valor) {
    return 'R$ ' + valor.toFixed(2).replace('.', ',');
  }

  // ----- Renderizar card√°pio (cria os cards dinamicamente a partir da API) -----
  async function renderizarCardapio() {
    const container = document.getElementById('menu-container');
    container.innerHTML = 'Carregando card√°pio...'; // Feedback para o usu√°rio

    const itensCardapio = await getProducts(); // Busca os produtos da API

    if (itensCardapio === null) {
        container.innerHTML = '<p class="text-center col-span-full text-red-500 font-bold">Erro ao conectar com o servidor. Verifique se a API est√° rodando.</p>';
        return;
    }

    allProducts = itensCardapio; // Salva os produtos globalmente

    container.innerHTML = ''; // Limpa o container antes de inserir os novos itens

    if (itensCardapio.length === 0) {
      container.innerHTML = '<p class="text-center col-span-full">Nenhum item dispon√≠vel no card√°pio.</p>';
      return;
    }

    itensCardapio.forEach(item => {
      const card = document.createElement('div');
      card.className = 'bg-[#ffffff] text-[#ff5400] p-4 rounded-xl shadow';

      card.innerHTML = `
        <img src="${item.imgUrl}" alt="${item.nome}" class="w-full h-40 object-cover rounded-md mb-4" />
        <h3 class="text-xl font-bold">${item.nome}</h3>
        <p class="text-sm text-gray-600">${item.descricao || ''}</p>
        <p class="text-lg mt-2">${formatarPreco(item.price)}</p>
        <button class="adicionar-btn mt-2 bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700"
                data-id="${item.id}"
                data-nome="${item.nome}"
                data-preco="${item.price}">
          Adicionar üõí
        </button>
      `;

      container.appendChild(card);
    });

    // Adiciona eventos aos bot√µes "Adicionar"
    document.querySelectorAll('.adicionar-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        const nome = e.target.dataset.nome;
        const preco = parseFloat(e.target.dataset.preco);
        adicionarAoCarrinho(id, nome, preco);
      });
    });
  }

    // ----- Renderizar mesas -----
    async function renderizarMesas() {
        const select = document.getElementById('mesa-select');
        select.innerHTML = '<option>Carregando mesas...</option>';

        const mesas = await getMesas();

        select.innerHTML = '';

        if (mesas === null) {
            select.innerHTML = '<option>Erro de conex√£o</option>';
            return;
        }

        if (mesas.length === 0) {
            select.innerHTML = '<option>Nenhuma mesa dispon√≠vel</option>';
            return;
        }

        mesas.forEach(mesa => {
            const option = document.createElement('option');
            option.value = mesa.id;
            option.textContent = mesa.numero;
            select.appendChild(option);
        });
    }

  // ----- Fun√ß√µes de manipula√ß√£o do carrinho -----
  function adicionarAoCarrinho(id, nome, preco) {
    if (carrinho[id]) {
      carrinho[id].quantidade++;
    } else {
      carrinho[id] = { id: id, nome: nome, quantidade: 1, preco: preco };
    }
    salvarCarrinho();
    renderizarCarrinho();
  }

  function incrementarItem(id) {
    if (carrinho[id]) {
      carrinho[id].quantidade++;
      salvarCarrinho();
      renderizarCarrinho();
    }
  }

  function decrementarItem(id) {
    if (carrinho[id]) {
      carrinho[id].quantidade--;
      if (carrinho[id].quantidade <= 0) {
        delete carrinho[id];
      }
      salvarCarrinho();
      renderizarCarrinho();
    }
  }

  function removerItem(id) {
    if (carrinho[id]) {
      delete carrinho[id];
      salvarCarrinho();
      renderizarCarrinho();
    }
  }

  // ----- Renderizar a tabela do carrinho -----
  function renderizarCarrinho() {
    const tbody = document.getElementById('carrinho-corpo');
    tbody.innerHTML = '';
    let total = 0;

    for (let id in carrinho) {
      const item = carrinho[id];
      const subtotal = item.quantidade * item.preco;
      total += subtotal;

      const tr = document.createElement('tr');
      tr.className = 'border-t';

      tr.innerHTML = `
        <td class="py-2">${item.nome}</td>
        <td>${item.quantidade}</td>
        <td>${formatarPreco(subtotal)}</td>
        <td class="space-x-2">
          <button class="incrementar-btn text-blue-600 hover:text-blue-800" data-id="${id}">+</button>
          <button class="decrementar-btn text-yellow-600 hover:text-yellow-800" data-id="${id}">-</button>
          <button class="remover-btn text-red-600 hover:text-red-800" data-id="${id}">
            <i class="fas fa-trash-alt"></i> <!-- √çcone lixeira -->
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    }

    // Se o carrinho estiver vazio
    if (Object.keys(carrinho).length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="4" class="py-4 text-gray-500">Carrinho vazio</td>';
      tbody.appendChild(tr);
    }

    // Atualiza o total
    document.getElementById('total-carrinho').innerText = `Total: ${formatarPreco(total)}`;

    // Adiciona eventos aos bot√µes do carrinho
    document.querySelectorAll('.incrementar-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        incrementarItem(id);
      });
    });

    document.querySelectorAll('.decrementar-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        decrementarItem(id);
      });
    });

    document.querySelectorAll('.remover-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('button').dataset.id;
        removerItem(id);
      });
    });
  }

  // ----- Finalizar pedido -----
  document.getElementById('confirmar-pedido').addEventListener('click', async () => {
    if (Object.keys(carrinho).length === 0) {
      alert('Seu carrinho est√° vazio!');
      return;
    }

    const mesaId = document.getElementById('mesa-select').value;
    if (!mesaId) {
        alert('Por favor, selecione uma mesa.');
        return;
    }

    const items = Object.values(carrinho).map(item => {
        const product = allProducts.find(p => p.id == item.id);
        return {
            quantidade: item.quantidade,
            price: item.preco,
            produto: product
        };
    });

    const total = items.reduce((sum, item) => sum + (item.quantidade * item.price), 0);

    const pedido = {
        mesa: { id: mesaId },
        items: items,
        total: total,
        status: 'SUBMETIDO'
    };

    try {
        const newOrder = await postPedido(pedido);
        alert(`Pedido #${newOrder.id} realizado com sucesso!`);
        carrinho = {};
        salvarCarrinho();
        renderizarCarrinho();
    } catch (error) {
        alert('Falha ao realizar o pedido. Tente novamente.');
    }
  });

  // ----- Inicializa√ß√£o -----
  renderizarCardapio();
  renderizarCarrinho();
  renderizarMesas();
</script>

</body>
</html>